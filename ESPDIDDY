local Players = game:GetService("Players")
local localPlayer = Players.LocalPlayer

espBoxes = {}

local function createESPBoxes(character)
	local hrp = Character:WaitForChild("HumanoidRootPart", 5)
	if not hrp then return end

	local g = Instance.new("BillboardGui")
	g.Name = "ESPBox"
	g.Adornee = hrp
	g.AlwaysOnTop = true
	g.Size = UDim2.new(4.5, 0, 5.5, 0)
	g.StudsOffset = Vector3.new(0, 0, 0)
	g.Parent = character

	local f = Instance.new("Frame")
	f.Size = UDim2.new(1, 0, 1, 0)
	f.BackgroundTransparency = 1
	f.BorderSizePixel = 0
	f.Parent = g

	local s = Instance.new("UIStroke")
	s.Color = Color3.FromRGB(255, 0, 0)
	s.Thickness = 2
	s.Parent = f

	return g
end

local function trackPlayer(player)
	local function onCharacterAdded(character)
		local esp = createESPBoxes(character)
		if esp then
		espBoxes[player] = esp
		end
	end

	if player.Character then
		onCharacterAdded(player.Character)
	end

	player.CharacterAdded:Connect(onCharacterAdded)
end

for i, players in ipairs(Players:GetPlayers()) do
	if player ~= localPlayer then
		trackPlayer(player)
	end
end

player.PlayerRemoving:Connect(function(player)
	local esp = espBoxes[player]
	if esp then
		esp:Destroy()
		espBoxes[player] = nil
	end
end)
